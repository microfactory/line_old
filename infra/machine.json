{
  "Comment": "A state machine that schedules tasks on workers",
  "StartAt": "Schedule",
  "States": {
    "Schedule": {
      "Next": "Deallocate",
      "Type": "Parallel",
      "Retry" : [{
        "ErrorEquals": ["Exception"],
        "IntervalSeconds": 10,
        "MaxAttempts": 999999,
        "BackoffRate": 1.1
      }],

      "Catch": [
        {
          "ErrorEquals": [ "States.ALL" ],
          "Next": "Deallocate"
        }
      ],

      "Branches": [{
        "StartAt": "Allocate",
        "States": {

          "Allocate": {
            "Next": "Run",
            "Type": "Task",
            "Resource": "${alloc_func_arn}"
          },

          "Run": {
            "End": true,
            "Type": "Parallel",
            "Retry" : [{
              "ErrorEquals": ["States.Timeout"],
              "IntervalSeconds": 3,
              "MaxAttempts": 5,
              "BackoffRate": 1.5
            }],
            "Branches": [
              {
                "StartAt": "RunActivity",
                "States": {
                  "RunActivity": {
                    "End": true,
                    "Type": "Task",
                    "Resource": "${run_act_arn}",
                    "TimeoutSeconds": 31622400,
                    "HeartbeatSeconds": 30
                  }
                }
              },

              {
                "StartAt": "RunDispatch",
                "States": {
                  "RunDispatch": {
                    "End": true,
                    "Type": "Task",
                    "Resource": "${dispatch_func_arn}"
                  }
                }
              }
            ]
          }
        }
      }]
    },
    "Deallocate": {
      "End": true,
      "Type": "Task",
      "Resource": "${dealloc_func_arn}"
    }
  }
}
